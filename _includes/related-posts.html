{% assign related_posts = "" | split: "" %}
{% assign max_related = 3 %}
{% assign min_common_tags = 1 %}

{% for post in site.posts %}
  {% if post.url != page.url %}
    {% assign common_tags = 0 %}
    {% for tag in post.tags %}
      {% if page.tags contains tag %}
        {% assign common_tags = common_tags | plus: 1 %}
      {% endif %}
    {% endfor %}
    {% if common_tags >= min_common_tags %}
      {% assign related_posts = related_posts | push: post %}
    {% endif %}
  {% endif %}
{% endfor %}

{% assign related_posts = related_posts | uniq | slice: 0, max_related %}

{% if related_posts.size < max_related %}
  {% assign remaining = max_related | minus: related_posts.size %}
  {% assign recent = site.posts | where_exp:"item", "item.url != page.url" | slice: 0, remaining %}
  {% for p in recent %}
    {% unless related_posts contains p %}
      {% assign related_posts = related_posts | push: p %}
    {% endunless %}
  {% endfor %}
{% endif %}

{% if related_posts.size > 0 %}
<section class="related-posts" style="margin-top: 4rem; border-top: 1px solid var(--card-border); padding-top: 2rem;">
  <h3 style="color: var(--purple1); margin-bottom: 1.5rem;">Related Posts</h3>
  <div class="blog-list">
    {% for post in related_posts limit:3 %}
      {% include post-card.html post=post %}
    {% endfor %}
  </div>
</section>
{% endif %}
