{% assign related_posts = "" | split: "" %}
{% assign max_related = 4 %}
{% assign min_common_tags = 1 %}

{% for post in site.posts %}
  {% if post.url != page.url %}
    {% assign common_tags = 0 %}
    {% for tag in post.tags %}
      {% if page.tags contains tag %}
        {% assign common_tags = common_tags | plus: 1 %}
      {% endif %}
    {% endfor %}
    {% if common_tags >= min_common_tags %}
      {% assign related_posts = related_posts | push: post %}
    {% endif %}
  {% endif %}
{% endfor %}

{% assign related_posts = related_posts | uniq | slice: 0, max_related %}

{% if related_posts.size < max_related %}
  {% assign remaining = max_related | minus: related_posts.size %}
  {% assign recent = site.posts | where_exp:"item", "item.url != page.url" | slice: 0, remaining %}
  {% for p in recent %}
    {% unless related_posts contains p %}
      {% assign related_posts = related_posts | push: p %}
    {% endunless %}
  {% endfor %}
{% endif %}

{% if related_posts.size > 0 %}
<div class="sidebar-related">
  <h3 style="font-size: 1.2rem; color: var(--text-main); margin-bottom: 1rem; margin-top: 0;">Related Posts</h3>
  <div style="display: flex; flex-direction: column; gap: 1rem;">
    {% for post in related_posts limit:4 %}
      <a href="{{ post.url | relative_url }}" class="compact-card">
        {% if post.image %}
        <div class="compact-card-bg" style="background-image: url('{{ post.image | relative_url }}');"></div>
        {% else %}
        <div class="compact-card-bg" style="background-color: var(--card-bg);"></div>
        {% endif %}
        <div class="compact-card-overlay"></div>
        <div class="compact-card-content">
           <div class="compact-card-title">{{ post.title }}</div>
           <div class="compact-card-date">{{ post.date | date: "%B %d, %Y" }}</div>
        </div>
      </a>
    {% endfor %}
  </div>
</div>
{% endif %}
